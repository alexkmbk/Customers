@model IEnumerable<Customers.Models.BankAccount>

<h1>@Html.ViewData["Title"]</h1>

@*Командная панель с кнопками управления таблицей*@
<p>
    <input type="button" value="New" onclick="NewClick()" autofocus style="width:100px" />
</p>


@if (Model.Count() == 0)
{
    <div>Нет данных для отображения</div>

}
else {
    <div>
        <a href="#bankaccounts_table" id="bankaccounts_table_input"></a>
        <table  id="bankaccounts_table" class="table table-striped table-condensed table-hover table-bordered">
            <thead>
                <tr>
                    <th>Номер</th>
                    <th>Контрагент</th>
                    <th>Банк</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var e in Model)
                {
                    <tr>
                        <td>@e.BankAccountNumber</td>
                        <td>@e.Customer.CustomerName</td>
                        <td>@e.Bank.BankName</td>
                        <td style="display:none;">@e.BankAccountId</td>
                        <td style="display:none;">@e.Customer.CustomerId</td>
                        <td style="display:none;">@e.Bank.BankId</td>
                        
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

<style>
    #customers_table tbody tr.highlight td {
        background-color: bisque;
    }

    #customers_table tbody tr.highlight {
        outline: none;
        border-color: #ffd800;
        box-shadow: 0 0 20px #ffd800;
        border: 5px solid #ffd800;
        border-radius: 7px;
    }

    table input {
        width: 100%;
        padding: 0px;
        margin: 0px;
    }

    }
</style>

<script>


    @*Press New button*@
    function NewClick() {

        $(function () {
            var dlg = document.getElementById('dialog_customer');
            dlg.title = 'Create new customer';
            // устанавливаем признак что запись новая
            dlg.setAttribute('isNew', true);
            $("#dialog_customer input[name='CustomerName']").val("");
            $("#dialog_customer input[name='CustomerId']").val("");
            $("#dialog_customer select[name='BusinessTypeName']").val("");

            $("#dialog_customer").dialog();
        });
    }

    function SaveData(e) {
        // Запрос на сервер для обновления данных
        var row = e.parent().parent();
        // После снятия фокуса, снова установим просто текст
        e.parent().html(e.val());

        var rowdata = new Array();

        row.find("td").each(function (index, value) {
            rowdata[index] = $(this).html();
        });
        $.ajax({
            type: 'POST',
            url: '@Url.Action("BankAccountsUpdate", "Customers")',
            data: { BankAccountNumber: rowdata[0], BankAccountId: rowdata[3], CustomerId: rowdata[4], BankId: rowdata[5] },
            success: function (data) {
                if (!data["Success"]) {
                    var myDiv = document.getElementById("formSetToken_divmsg");
                    myDiv.innerHTML = "Ошибка записи: " + data["Errors"];
                }
            },
            error: function (xhr, str) {
                var myDiv = document.getElementById("formSetToken_divmsg");
                myDiv.innerHTML = "Ошибка записи: " + xhr.responseCode;
            }
        });
    }

    function EditRow(e) {
        var cell = e;
        var col = cell.parent().children().index(cell);
        var val = e.html();
        // если первая колонка, то для редактирования устанавливается поле input
        if (col == 0) {
            cell.html('<input type="text" value="' + val + '" />');
            var input = cell.find('input');
        }
            // если вторая колонка, то для редактирования устанавливается поле select
        else if (col == 1) {
            var options = "<option>ФизЛицо</option><option>ЮрЛицо</option>";
            cell.html('<select value="' + val + '" >' + options + "</select>");
            var input = cell.find('select');
        }
        // сохраним в поле input в атрибуте prevVal значение ячейки до изменения
        input.attr("prevVal", val);
        // присвоем полю input класс tableinput для облегчения использования селекторов
        input.addClass("tableinput");
        input.focus();
        // при потере фокуса ввода сохраняем введенные значения
        input.on('blur', function () {
            SaveData($(this));
        });
    }

    // подсвечивание строки
    $('#customers_table > tbody > tr').on('click', function () {
        $(this).addClass('highlight').siblings().removeClass('highlight');
    });

    // двойной клик по ячейке таблицы, проиходсит вход в режим редактирования
    $('#customers_table > tbody > tr > td').on('dblclick', function () {
        EditRow($(this));
    });


    // Обработка ввода с клавиатуры

    $(document).on('keydown', function (e) {
        // если нажата клавиша ESC и выполняется редактирование ячейки,
        // то необходимо завершить редактирование не сохраняя введенные данные
        if (e.keyCode == $.ui.keyCode.ESCAPE) {
            if (e.target.className == "tableinput") {
                e.preventDefault();
                var input = $(".tableinput").eq(0);
                var prevVal = input.attr("prevVal");
                input.parent().html(prevVal);
                $("#customers_table_input").focus();
            }
        }
            // если  нажата клавиша ENTER во время редактирования ячейки,
            // то необходимо сохранить введенные данные и перейти к редактированию следующей колонки
        else if (e.keyCode == $.ui.keyCode.ENTER) {
            if (e.target.className == "tableinput") {
                e.preventDefault();
                var input = $(".tableinput").eq(0);
                var td = input.parent();
                SaveData(input);
                if (td.parent().children().index(td) < 1) {
                    EditRow(td.next('td'));
                }
                else {
                    $("#customers_table_input").focus();
                }
            }
        }

    });

    // Если нажали клавишу внутри таблицы
    $('#customers_table_input').on('keydown', function (e) {
        // перемещение фокуса строки на одну строку вниз
        if (e.keyCode == $.ui.keyCode.DOWN) {
            e.preventDefault();
            $('#customers_table .highlight').next().addClass('highlight').siblings().removeClass('highlight');
        }

        // перемещение фокуса строки на одну строку вверх
        if (e.keyCode == $.ui.keyCode.UP) {
            e.preventDefault();
            $('#customers_table .highlight').prev().addClass('highlight').siblings().removeClass('highlight');
        }
        // вход в режим редактирования ячейки при нажатии клавише ENTER
        if (e.keyCode == $.ui.keyCode.ENTER) {
            e.preventDefault();
            EditRow($('#customers_table .highlight > td').eq(0));
        }
    });

    // Устанавливаем фокус на таблицу если щелкнули мышкой внутри таблицы
    $("body").click(function (e) {
        if (e.target.id == "customers_table" || $(e.target).parents("#customers_table").size()) {
            $("#customers_table_input").focus();
        }
    });
</script>